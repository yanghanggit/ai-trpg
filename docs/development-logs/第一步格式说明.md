# "第一步:你的角色信息 与 当前场景信息" 格式说明

## 概述

在 `_handle_single_actor_observe_and_plan` 函数中,第一步为角色提供两部分关键信息:

1. **角色个人信息**(自己)
2. **当前场景信息**(环境+所有角色)

---

## 1. 角色个人信息(第一个JSON块)

**目的**: 让角色了解**自己的完整状态**

**示例**:

```json
{
  "name": "加斯科因",
  "appearance": "身高约180厘米,体格健壮但略显消瘦...",
  "attributes": {
    "health": 1,
    "max_health": 100,
    "attack": 10
  },
  "effects": []
}
```

**包含内容**:

- `name`: 自己的名字
- `appearance`: 自己的外观描述
- `attributes`: 自己的战斗数据
  - `health`: 当前生命值
  - `max_health`: 最大生命值
  - `attack`: 攻击力
- `effects`: 自己的状态效果列表

**用途**:

- 角色评估自己的战斗能力
- 判断行动可行性(例如生命值1/100,需谨慎)
- 了解自身特殊能力(effects)

---

## 2. 当前场景信息(第二个JSON块)

**目的**: 让角色了解**所处的环境和其他角色**

**示例**:

```json
{
  "name": "奥顿教堂墓地",
  "environment": "生锈的铁栅栏门半开着,门上挂着氧化的铜制教会徽记...",
  "actor_states": "**加斯科因**: 墓地中央,靠近天使雕像 | 来回踱步 | 手持猎人斧\n**艾琳**: 墓地东侧,枯树阴影中 | 隐藏状态 | 保持静止观察\n**外乡人**: 墓地南侧入口,距铁栅栏门约10米 | 站立 | 环顾四周",
  "actors_appearance": [
    {
      "name": "艾琳",
      "appearance": "身高约170厘米,身材修长精瘦..."
    },
    {
      "name": "外乡人",
      "appearance": "身高约175厘米,体型中等偏瘦..."
    }
  ]
}
```

**包含内容**:

- `name`: 场景名称
- `environment`: 场景环境的完整描述
  - 地形、建筑、物体
  - 光线、气氛、感官细节
- `actor_states`: **所有角色**(包括自己)的当前状态
  - 位置(相对地标)
  - 姿态(行为/动作)
  - 特殊状态(如"隐藏")
- `actors_appearance`: **其他角色**的外观列表
  - **注意**: 不包括自己的外观(已在第一部分提供)
  - 让角色知道周围有谁、他们长什么样

**用途**:

- 了解场景布局和环境特征
- 知道其他角色的位置和行为
- 识别潜在的威胁或盟友
- 规划移动路线和行动策略

---

## 3. 两部分的关系

| 维度 | 角色个人信息 | 场景信息 |
|------|------------|---------|
| **视角** | 第一人称("我是谁") | 第三人称("世界是什么样") |
| **焦点** | 自己的属性和状态 | 环境+其他角色 |
| **外观** | 包含自己的appearance | 包含**其他角色**的appearance |
| **位置** | 不包含(在场景信息中) | 包含**所有角色**的位置状态 |
| **战斗数据** | 包含自己的attributes | 不包含(这是私有信息) |

---

## 4. 完整工作流

```text
第一步: 提供信息
├── 角色个人信息 → "我是谁?我的状态如何?"
└── 场景信息 → "我在哪里?周围有谁?环境如何?"

第二步: 观察场景
└── 基于第一步的信息,用第一人称描述所见所闻

第三步: 规划行动
└── 基于观察结果,规划下一步行动(考虑自身能力)

输出: JSON
└── {observation: "...", plan: "..."}
```

---

## 5. 设计原因

### 为什么分两个JSON块?

1. **信息分层清晰**
   - 角色信息 = 内在状态(私密)
   - 场景信息 = 外在环境(共享)

2. **方便数据获取**
   - 角色信息从 `game://actor/{name}` 获取
   - 场景信息从 `game://stage/{name}` 获取

3. **避免信息冗余**
   - 角色个人信息不包含位置(在场景信息中)
   - 场景信息的actors_appearance不包含自己(在个人信息中)

### 为什么actor_states包含自己?

- 角色需要知道**自己在场景中的位置和姿态**
- 例如:"我在墓地中央,靠近天使雕像"
- 这样角色才能规划相对移动("向东移动到铁门")

### 为什么actors_appearance不包含自己?

- 角色的外观已在个人信息中提供
- 避免重复数据
- 减少token消耗

---

## 6. 实际示例分析

### 加斯科因的视角

**个人信息告诉他**:

- "我叫加斯科因"
- "我的生命值只剩1/100(濒死!)"
- "我的攻击力是10"
- "我没有特殊效果"
- "我长这个样子(详细外观)"

**场景信息告诉他**:

- "我在奥顿教堂墓地"
- "环境是这样的(墓碑、天使雕像、铁门...)"
- "我的位置是:墓地中央,靠近天使雕像,正在来回踱步,手持猎人斧"
- "艾琳在东侧,隐藏状态(我看不到她)"
- "外乡人在南侧入口,站立,环顾四周"
- "艾琳长这样(详细外观)"
- "外乡人长这样(详细外观)"

**基于这些信息,加斯科因会**:

- 观察到外乡人的存在(但看不到艾琳)
- 意识到自己生命值极低,非常脆弱
- 规划警告外乡人或逃离的行动

---

## 7. 与 `_build_actor_plan_prompt` 的对比

| 函数 | 用途 | 格式 | 原因 |
|------|------|------|------|
| `_handle_single_actor_observe_and_plan` | 角色自我观察和规划 | JSON | 完整数据结构,自我视角 |
| `_build_actor_plan_prompt` | 场景执行时展示给场景Agent | Markdown | 多角色汇总,第三人称视角,易读 |

---

## 8. 总结

**第一步的两个JSON块是为了**:

1. 让角色清楚地知道**自己的状态**(内在)
2. 让角色清楚地知道**环境和他人**(外在)
3. 为第二步(观察)和第三步(规划)提供完整的信息基础

**这种分离设计**:

- ✅ 信息来源清晰(actor resource vs stage resource)
- ✅ 避免数据冗余(外观、位置合理分布)
- ✅ 符合角色认知模型(我是谁 + 世界是什么样)
- ✅ 便于LLM理解和处理
